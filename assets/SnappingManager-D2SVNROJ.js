const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/SelfSnappingEngine-CasfcOSG.js","assets/index-Dg_V7Ho7.js","assets/index-DwZnnNDp.css","assets/euclideanLengthMeasurementUtils-CNvYyOvR.js","assets/geodesicUtils-BySj0T3d.js","assets/geometry2dUtils-BjT1yd1H.js","assets/angularMeasurementUtils-DHtIOqzw.js","assets/geodeticLengthOperator-B2eCWGqZ.js","assets/geodeticCurveType-CirnHLSB.js","assets/GridSnappingEngine-B-5pfFD-.js","assets/gridUtils-C2YiueMn.js","assets/FeatureSnappingEngine-KVkaeZUT.js"])))=>i.map(i=>d[i]);
import{bI as W,bM as m,n as o,p as c,u as F,dm as te,d0 as ne,dJ as ie,gE as se,cg as re,hI as P,oe as ae,cq as S,uY as oe,gG as de,ys as ce,fo as le,oO as he,oP as N,lN as ue,c9 as pe,ho as fe,dt as ge,uP as D,b2 as ye,eH as _e,S as A,bZ as ve,gA as Se,bV as be,_ as M,i as L,g3 as j,g2 as we,hE as z,f_ as me}from"./index-Dg_V7Ho7.js";import{p as C,K as Pe,k as p,L as Ee,g as $e,j as Te,M as B,w as J,r as Re,n as K,N as xe,b as Z,t as Q,P as E,c as O,Q as k,y as Ce,B as De}from"./euclideanLengthMeasurementUtils-CNvYyOvR.js";import{m as Me,l as Y}from"./geodeticLengthOperator-B2eCWGqZ.js";import{q as Le,b as Oe,R as qe}from"./geodesicUtils-BySj0T3d.js";let y=class extends W{constructor(t){super(t),this.layer=null,this.enabled=!0,this.updating=!1,this.availability=1,this.sublayerSources=new m}};o([c({constructOnly:!0})],y.prototype,"layer",void 0),o([c()],y.prototype,"enabled",void 0),o([c()],y.prototype,"updating",void 0),o([c()],y.prototype,"availability",void 0),o([c()],y.prototype,"sublayerSources",void 0),y=o([F("esri.views.interactive.snapping.FeatureSnappingLayerSource")],y);let u=class extends W{constructor(e){super(e),this.enabled=!1,this.enabledToggled=!1,this.forceDisabled=!1,this.selfEnabled=!0,this.featureEnabled=!0,this.gridEnabled=!1,this.attributeRulesEnabled=!1,this.featureSources=new m,this.distance=C.distance,this.touchSensitivityMultiplier=C.touchSensitivityMultiplier}get effectiveEnabled(){return!this.forceDisabled&&(this.enabledToggled?!this.enabled:this.enabled)}get effectiveGridEnabled(){return this.effectiveEnabled&&this.gridEnabled}get effectiveSelfEnabled(){return this.effectiveEnabled&&this.selfEnabled}get effectiveFeatureEnabled(){return this.effectiveEnabled&&this.featureEnabled}get _effectiveFeatureSources(){const e=this.featureSources;e.some(G)&&te.getLogger(this).warnOnce("Do not configure SubtypeGroupLayer sources in SnappingOptions.featureSources directly. Create a FeatureSnappingLayerSource for each SubtypeSublayer.");const t=e.filter(Ie),n=this._get("_effectiveFeatureSources")?.filter(G)??new m;for(const a of t){const h=n.find(l=>l.layer===a.layer.parent);if(h)h.sublayerSources.includes(a)||h.sublayerSources.add(a);else if(a.layer.parent){const l=new y({layer:a.layer.parent});l.sublayerSources.add(a),n.add(l)}}for(const a of n){const h=a.sublayerSources.filter(l=>!t.includes(l));a.sublayerSources.removeMany(h)}n.removeMany(n.filter(a=>a.sublayerSources.length===0));const i=e.filter(Ve),s=this._get("_effectiveFeatureSources")??new m,{added:r,removed:d}=ne(s.toArray(),[...i,...n]);return s.removeMany(d),s.addMany(r),s}};function G(e){return e.layer.type==="subtype-group"}function Ve(e){return e.layer.type!=="subtype-group"}function Ie(e){return e.layer.type==="subtype-sublayer"}o([c()],u.prototype,"enabled",void 0),o([c()],u.prototype,"enabledToggled",void 0),o([c()],u.prototype,"forceDisabled",void 0),o([c()],u.prototype,"selfEnabled",void 0),o([c()],u.prototype,"featureEnabled",void 0),o([c()],u.prototype,"gridEnabled",void 0),o([c()],u.prototype,"attributeRulesEnabled",void 0),o([c({type:m.ofType(y)})],u.prototype,"featureSources",void 0),o([c()],u.prototype,"distance",void 0),o([c()],u.prototype,"touchSensitivityMultiplier",void 0),o([c({readOnly:!0})],u.prototype,"effectiveEnabled",null),o([c({readOnly:!0})],u.prototype,"effectiveGridEnabled",null),o([c({readOnly:!0})],u.prototype,"effectiveSelfEnabled",null),o([c({readOnly:!0})],u.prototype,"effectiveFeatureEnabled",null),o([c({readOnly:!0})],u.prototype,"_effectiveFeatureSources",null),u=o([F("esri.views.interactive.snapping.SnappingOptions")],u);class b{constructor(t,n,i,s){this.targetPoint=t,this.constraint=n,this.isDraped=i,this.domain=s}}let X=class extends b{constructor({targetPoint:t,objectId:n,constraint:i,isDraped:s}){super(t,i,s,1),this.objectId=n}};class He extends X{constructor(t){super({...t,isDraped:!0,constraint:new Pe(t.edgeStart,t.edgeEnd,t.getGroundElevation)})}get hints(){return[new p(1,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}}let ze=class extends X{constructor(t){super({...t,constraint:new Ee(t.edgeStart,t.edgeEnd)})}get hints(){return[new p(1,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}},x=class extends b{constructor(t,n,i,s){super(t,new $e(t),s,3),this.first=n,this.second=i}get hints(){return this.first.targetPoint=this.targetPoint,this.second.targetPoint=this.targetPoint,[...this.first.hints,...this.second.hints,new Te(this.targetPoint,this.isDraped,this.domain)]}},Fe=class extends b{constructor({lineStart:t,lineEnd:n,targetPoint:i,isDraped:s}){super(i,new B(t,n),s,2),this._referenceLineHint=new p(2,t,n,s,this.domain)}get hints(){return[this._referenceLineHint,new p(0,this._lineEndClosestToTarget(),this.targetPoint,this.isDraped,this.domain)]}_lineEndClosestToTarget(){return this.constraint.closestEndTo(this.targetPoint)}},Ae=class extends b{constructor({referenceLine:t,lineStart:n,targetPoint:i,isDraped:s}){const r=ie(n),{left:d,right:a}=t;se(r,re(r,r,a),d),super(i,new B(n,J(r)),s,2),this._referenceLines=[{edge:t,fadeLeft:!0,fadeRight:!0}]}get hints(){return[new p(0,this.constraint.start,this.targetPoint,this.isDraped,this.domain),new Re(this.constraint.start,this.targetPoint,this.isDraped,this.domain),...this._referenceLines.map(t=>new p(1,t.edge.left,t.edge.right,this.isDraped,this.domain,t.fadeLeft,t.fadeRight))]}addReferenceLine(t){const n={edge:t,fadeLeft:!0,fadeRight:!0};this._referenceLines.forEach(i=>{P(t.right,i.edge.left)&&(i.fadeLeft=!1,n.fadeRight=!1),P(t.right,i.edge.right)&&(i.fadeRight=!1,n.fadeRight=!1),P(t.left,i.edge.right)&&(i.fadeRight=!1,n.fadeLeft=!1),P(t.left,i.edge.left)&&(i.fadeLeft=!1,n.fadeLeft=!1)}),this._referenceLines.push(n)}};class je extends b{constructor({targetPoint:t,constraint:n,previousVertex:i,otherVertex:s,otherVertexType:r,isDraped:d,selfSnappingType:a,objectId:h,domain:l}){super(t,n,d,l??2),this.previousVertex=i,this.otherVertex=s,this.otherVertexType=r,this.selfSnappingType=a??0,this.objectId=h??null}get hints(){const t=this.previousVertex,n=this.otherVertexType===1?this.otherVertex:this.targetPoint,i=this.otherVertexType===1?this.targetPoint:this.otherVertex;return[new p(0,n,i,this.isDraped,this.domain),new p(1,t,n,this.isDraped,this.domain),new K(this.previousVertex,n,i,this.isDraped,this.domain)]}}let Ze=class extends b{constructor({targetPoint:t,point1:n,point2:i,isDraped:s}){super(t,new xe(J(ae(S(),n,i,.5)),.5*oe(Z(n),Z(i))),s,2),this._p1=n,this._p2=i}get hints(){return[new p(1,this.targetPoint,this._p1,this.isDraped,this.domain),new p(1,this.targetPoint,this._p2,this.isDraped,this.domain),new K(this._p1,this.targetPoint,this._p2,this.isDraped,this.domain)]}};function St(e,t,n,i){const s=n.projectToRenderScreen(e,Ue),r=n.projectToRenderScreen(t,We);return s==null||r==null?null:(le(i,r,s),he(i,i),i)}function ke(e,t,n,i,s=S()){const r=de(Ge,e);return r[2]=ce(i,r,t,n)||0,i.renderCoordsHelper.toRenderCoords(r,t,s),s}const Ge=S(),Ue=N(),We=N();function Ne(e,t,n,i){return i.type==="2d"?($.x=e[0],$.y=e[1],$.spatialReference=t,i.toScreen($)):(ke(e,t,n,i,U),i.state.camera.projectToScreen(U,q),ue(q[0],q[1]))}const $=pe(0,0,0,null),U=S(),q=fe();function Be(e){const{spatialReference:t}=e;return Q(t,et,tt,e)}function Je(e,t){if(!ge(e.spatialReference,t.spatialReference))return null;const{spatialReference:n}=e;return T[0]=e.x,T[1]=e.y,T[2]=e.hasZ?e.z:0,R[0]=t.x,R[1]=t.y,R[2]=t.hasZ?t.z:0,ee(T,R,n)}function ee(e,t,n){return Q(n,Ye,Xe,e,t,n)}const Ke={geodesicLength:Be,geodesicDistanceBetweenPoints:Je,geodesicDistance:ee};async function Qe(){return await Me(),Ke}function Ye(e,t,n){return D(Le(it,e,t,n).distance,"meters")}function Xe(e,t,n){return D(Y(nt(e,t,n),{unit:"meters"}),"meters")}function et(e){return D(qe([e],"meters")[0],"meters")}function tt(e){return D(Y(e,{unit:"meters"}),"meters")}function nt(e,t,n){return new ye({spatialReference:n,paths:[[[...e],[...t]]]})}const it=new Oe,T=S(),R=S();let g=class extends _e{constructor(e){super(e),this.options=new u,this._engineCache=new Map,this._loadTask=null,this._engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=0}initialize(){this.addHandles([A(()=>{const{distance:e,touchSensitivityMultiplier:t,effectiveSelfEnabled:n,effectiveFeatureEnabled:i,effectiveGridEnabled:s}=this.options;return{selfEnabled:n,featureEnabled:i,gridEnabled:this.view.type==="2d"&&s,viewReady:this.view.ready,viewSpatialReference:this.view.spatialReference,distance:e,touchSensitivityMultiplier:t}},(e,t)=>{t&&(this.doneSnapping(),this.emit("changed")),this._loadTask?.abort(),this._loadTask=Se(n=>this._updateEngines(e,t,n))},ve),A(()=>this.options,e=>{for(const t of this._engines)t.options=e},be)])}destroy(){this._loadTask?.abort(),this._destroyEngines()}get updating(){return this._engines.some(e=>e.updating)||!this._loadTask?.finished}_destroyEngines(){this._engineCache.forEach(e=>e.destroy()),this._engineCache.clear(),this._engines=[]}async _updateEngines(e,t,n){if(!e.viewReady)return void this._destroyEngines();t?.viewSpatialReference!==e.viewSpatialReference&&this._destroyEngines();const i=this._engineCache,s=await Promise.allSettled([e.featureEnabled&&!i.has("feature")?this._createFeatureSnappingEngine(n):void 0,e.selfEnabled&&!i.has("self")?this._createSelfSnappingEngine(n):void 0,e.gridEnabled&&!i.has("grid")?this._createGridSnappingEngine(n):void 0]);if(n.aborted)for(const r of s)r.status==="fulfilled"&&r.value?.engine.destroy();else{for(const r of s)r.status==="fulfilled"&&r.value&&i.set(r.value.type,r.value.engine);this._engines=Array.from(i.values())}}async _createSelfSnappingEngine(e){const[{SelfSnappingEngine:t},n]=await Promise.all([M(()=>import("./SelfSnappingEngine-CasfcOSG.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8])),Qe()]);return L(e),{type:"self",engine:new t({view:this.view,options:this.options,geodesicLengthMeasurementUtils:n})}}async _createGridSnappingEngine(e){const{view:t}=this;if(t.type!=="2d")return;const{GridSnappingEngine:n}=await M(()=>import("./GridSnappingEngine-B-5pfFD-.js"),__vite__mapDeps([9,1,2,10,4,3,5,7,8]));return L(e),{type:"grid",engine:new n({view:t,options:this.options})}}async _createFeatureSnappingEngine(e){const{FeatureSnappingEngine:t}=await M(()=>import("./FeatureSnappingEngine-KVkaeZUT.js"),__vite__mapDeps([11,1,2,3,4,5,7,8]));L(e);const{view:n,options:i}=this,{spatialReference:s}=n;return{type:"feature",engine:new t({view:n,options:i,spatialReference:s})}}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,n=e*t;return n*n}snap(e){return at(e)?this._snapMultiPoint(e):this._snapSinglePoint(e)}update(e){const{point:t,context:n}=e;this._removeVisualization();const i=this._currentMainCandidate;if(i==null)return t;const s=this._selectUpdateInput(e);if(s==null)return t;const{spatialReference:r}=n,d=j(s,r);if(d==null)return t;const{view:a}=this,{elevationInfo:h,visualizer:l}=n,f=[],_=E(d,a,h),v=i.constraint.closestTo(_);if(!this._arePointsWithinScreenThreshold(_,v,n)||!I(i,n.drawConstraints))return this._resetSnappingState(),t;i.targetPoint=O(v),f.push(...i.hints);for(const w of this._currentOtherActiveCandidates)I(w,n.drawConstraints)&&(w.targetPoint=O(v),f.push(...w.hints));return l!=null&&this.addHandles(l.draw(f,{spatialReference:r,elevationInfo:ot(n),view:a,selfSnappingZ:n.selfSnappingZ}),V),k(v,a,t,n)}doneSnapping(){this._removeVisualization(),this._resetSnappingState()}_selectUpdateInput({point:e,scenePoint:t}){switch(this._currentSnappedType){case 0:return e;case 1:return t}}_resetSnappingState(){this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=0}_removeVisualization(){this.removeHandles(V)}async _snapSinglePoint({point:e,context:t,signal:n}){const{view:i}=this,{elevationInfo:s}=t,r=E(e,i,s),d=await this._fetchCandidates(r,3,t,n);return this._createSnapResult(r,0,d,i,e,t,n)}async _snapMultiPoint({point:e,scenePoint:t,context:n,signal:i}){const{view:s}=this,{coordinateHelper:r,elevationInfo:d,spatialReference:a}=n;await we(t.spatialReference,a);const h=j(t,a),l=E(h,s,d),f=await this._fetchCandidates(l,1,n,i);if(f.length>0){const w=await this._fetchCandidates(l,2,n,i);return this._createSnapResult(l,1,[...f,...w],s,h,n,i)}const _=E(e,s,d),v=await this._fetchCandidates(_,2,n,i);return this._createSnapResult(_,0,v,s,{z:r.hasZ()&&e.hasZ?e.z??0:void 0,m:r.hasM()&&e.hasM?e.m??0:void 0},n,i)}async _fetchCandidates(e,t,n,i){return(await Promise.all(this._engines.map(s=>s.fetchCandidates(e,t,n,i)))).flat()}_createSnapResult(e,t,n,i,s,r,d){return{get valid(){return!me(d)},apply:()=>{const{spatialReference:a}=r,{snappedPoint:h,hints:l}=this._processCandidates(e,t,n,r);return this._removeVisualization(),r.visualizer!=null&&this.addHandles(r.visualizer.draw(l,{spatialReference:a,elevationInfo:z,view:i,selfSnappingZ:r.selfSnappingZ}),V),k(h,i,s,r)}}}_processCandidates(e,t,n,i){if(n.length<1)return this.doneSnapping(),{snappedPoint:e,hints:[]};this._currentSnappedType!==t&&this._resetSnappingState(),Ce(e,n);const s=this._currentMainCandidate;if(s!=null){const r=rt(s,n);if(r>=0){if(!(n[r]instanceof x))return this._intersectWithOtherCandidates(r,n,e,t,i);if(this._arePointsWithinScreenThreshold(e,s.targetPoint,i))return this._updateSnappingCandidate(s,t,n,i)}}return this._intersectWithOtherCandidates(0,n,e,t,i)}_intersectWithOtherCandidates(e,t,n,i,s){const{coordinateHelper:r}=s,d=t[e],a=[];for(let h=0;h<t.length;++h){if(h===e)continue;const l=t[h],f=d.constraint.intersect(l.constraint);if(f)for(const _ of f.closestPoints(d.targetPoint))a.push([new x(O(_),d,l,l.isDraped),this._squaredScreenDistance(n,_,r)])}return a.length>0&&(a.sort((h,l)=>h[1]-l[1]),a[0][1]<this._squaredPointProximityThreshold(s.pointer))?this._updateSnappingCandidate(a[0][0],i,t,s):I(d,s.drawConstraints)?this._updateSnappingCandidate(d,i,t,s):{snappedPoint:n,hints:[]}}_updateSnappingCandidate(e,t,n,i){this.doneSnapping(),this._currentMainCandidate=e,this._currentSnappedType=t;const s=this._currentMainCandidate.targetPoint,r=[];r.push(...e.hints);for(const d of n){if(e instanceof x){if(d.constraint.equals(e.first.constraint)||d.constraint.equals(e.second.constraint))continue}else if(d.constraint.equals(e.constraint))continue;const a=d.constraint.closestTo(s);this._squaredScreenDistance(a,s,i.coordinateHelper)<st()&&(d.targetPoint=s,this._currentOtherActiveCandidates.push(d),r.push(...d.hints))}return{snappedPoint:s,hints:r}}_squaredPointProximityThreshold(e){return e==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}_arePointsWithinScreenThreshold(e,t,n){return this._squaredScreenDistance(e,t,n.coordinateHelper)<this._squaredPointProximityThreshold(n.pointer)}_squaredScreenDistance(e,t,n){return De(this._toScreen(e,n),this._toScreen(t,n))}_toScreen(e,t){return Ne(e,t.spatialReference,z,this.view)}get test(){}};o([c({constructOnly:!0})],g.prototype,"view",void 0),o([c()],g.prototype,"options",void 0),o([c({readOnly:!0})],g.prototype,"updating",null),o([c()],g.prototype,"_loadTask",void 0),o([c()],g.prototype,"_engines",void 0),o([c()],g.prototype,"_squaredMouseProximityThreshold",null),o([c()],g.prototype,"_squaredTouchProximityThreshold",null),g=o([F("esri.views.interactive.snapping.SnappingManager")],g);const V="visualization-handle";function st(){return C.satisfiesConstraintScreenThreshold*C.satisfiesConstraintScreenThreshold}function I(e,t){return!t||t.direction==null&&t.distance==null||!(e instanceof He||e instanceof ze||e instanceof Fe||e instanceof Ae||e instanceof Ze)&&(!(e instanceof je)||t.direction==null&&e.selfSnappingType===1)}function rt(e,t){return e instanceof x?H(t,e.first)>=0&&H(t,e.second)>=0?0:-1:H(t,e)}function H(e,t){let n=-1;for(let i=0;i<e.length;++i)if(t.constraint.equals(e[i].constraint)){n=i;break}return n}function at(e){return e.scenePoint!=null}function ot({coordinateHelper:e,elevationInfo:t}){return e.hasZ()?z:t}export{Fe as a,ze as b,X as c,St as d,He as e,ke as f,Qe as g,Ae as h,y as i,Ze as j,x as n,g as q,je as r,Ne as s,u};
